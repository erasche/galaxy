{"version":3,"sources":["mvc/form/form-view.js"],"names":["Backbone","View","extend","initialize","options","model","Model","initial_errors","cls","icon","always_refresh","status","hide_operations","onchange","set","setElement","render","update","new_model","self","data","matchModel","node","input_id","input","input_list","field","field_list","refreshDefinition","_","isEqual","new_options","indexOf","type","i","opt","length","push","label","value","trigger","Galaxy","emit","debug","wait","active","is_dynamic","unwait","highlight","message","silent","input_element","element_list","error","portlet","expand","$panel","$el","parents","filter","$","css","first","animate","scrollTop","offset","top","position","errors","error_messages","matchResponse","off","Manager","_renderForm","create","get","attributes","current_check","checksum","on","refresh_on_change","new_check","each","reset","remove","UnescapedMessage","section","inputs","title","title_id","operations","buttons","collapsible","collapsed","onchange_title","append","empty","persistent"],"mappings":"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","file":"../../../scripts/mvc/form/form-view.js","sourcesContent":["/**\n    This is the main class of the form plugin. It is referenced as 'app' in lower level modules.\n*/\nimport Portlet from \"mvc/ui/ui-portlet\";\nimport Ui from \"mvc/ui/ui-misc\";\nimport FormSection from \"mvc/form/form-section\";\nimport FormData from \"mvc/form/form-data\";\nexport default Backbone.View.extend({\n    initialize: function(options) {\n        this.model = new Backbone.Model({\n            initial_errors: false,\n            cls: \"ui-portlet-limited\",\n            icon: null,\n            always_refresh: true,\n            status: \"warning\",\n            hide_operations: false,\n            onchange: function() {}\n        }).set(options);\n        this.setElement(\"<div/>\");\n        this.render();\n    },\n\n    /** Update available options */\n    update: function(new_model) {\n        var self = this;\n        this.data.matchModel(new_model, (node, input_id) => {\n            var input = self.input_list[input_id];\n            var field = self.field_list[input_id];\n            if (field.refreshDefinition) {\n                field.refreshDefinition(node);\n            }\n            if (input && input.options) {\n                if (!_.isEqual(input.options, node.options)) {\n                    input.options = node.options;\n                    if (field.update) {\n                        var new_options = [];\n                        if ([\"data\", \"data_collection\", \"drill_down\"].indexOf(input.type) != -1) {\n                            new_options = input.options;\n                        } else {\n                            for (var i in node.options) {\n                                var opt = node.options[i];\n                                if (opt.length > 2) {\n                                    new_options.push({\n                                        label: opt[0],\n                                        value: opt[1]\n                                    });\n                                }\n                            }\n                        }\n                        field.update(new_options);\n                        field.trigger(\"change\");\n                        Galaxy.emit.debug(\"form-view::update()\", `Updating options for ${input_id}`);\n                    }\n                }\n            }\n        });\n    },\n\n    /** Set form into wait mode */\n    wait: function(active) {\n        for (var i in this.input_list) {\n            var field = this.field_list[i];\n            var input = this.input_list[i];\n            if (input.is_dynamic && field.wait && field.unwait) {\n                field[active ? \"wait\" : \"unwait\"]();\n            }\n        }\n    },\n\n    /** Highlight and scroll to input element (currently only used for error notifications) */\n    highlight: function(input_id, message, silent) {\n        var input_element = this.element_list[input_id];\n        if (input_element) {\n            input_element.error(message || \"Please verify this parameter.\");\n            this.portlet.expand();\n            this.trigger(\"expand\", input_id);\n            if (!silent) {\n                var $panel = this.$el\n                    .parents()\n                    .filter(function() {\n                        return [\"auto\", \"scroll\"].indexOf($(this).css(\"overflow\")) != -1;\n                    })\n                    .first();\n                $panel.animate(\n                    {\n                        scrollTop: $panel.scrollTop() + input_element.$el.offset().top - $panel.position().top - 120\n                    },\n                    500\n                );\n            }\n        }\n    },\n\n    /** Highlights errors */\n    errors: function(options) {\n        this.trigger(\"reset\");\n        if (options && options.errors) {\n            var error_messages = this.data.matchResponse(options.errors);\n            for (var input_id in this.element_list) {\n                if (error_messages[input_id]) {\n                    this.highlight(input_id, error_messages[input_id], true);\n                }\n            }\n        }\n    },\n\n    /** Render tool form */\n    render: function() {\n        var self = this;\n        this.off(\"change\");\n        this.off(\"reset\");\n        // contains the dom field elements as created by the parameter factory i.e. form-parameters\n        this.field_list = {};\n        // contains input definitions/dictionaries as provided by the parameters to_dict() function through the api\n        this.input_list = {};\n        // contains the dom elements of each input element i.e. form-input which wraps the actual input field\n        this.element_list = {};\n        // converts the form into a json data structure\n        this.data = new FormData.Manager(this);\n        this._renderForm();\n        this.data.create();\n        if (this.model.get(\"initial_errors\")) {\n            this.errors(this.model.attributes);\n        }\n        // add listener which triggers on checksum change, and reset the form input wrappers\n        var current_check = this.data.checksum();\n        this.on(\"change\", input_id => {\n            var input = self.input_list[input_id];\n            if (!input || input.refresh_on_change || self.model.get(\"always_refresh\")) {\n                var new_check = self.data.checksum();\n                if (new_check != current_check) {\n                    current_check = new_check;\n                    self.model.get(\"onchange\")();\n                }\n            }\n        });\n        this.on(\"reset\", () => {\n            _.each(self.element_list, input_element => {\n                input_element.reset();\n            });\n        });\n        return this;\n    },\n\n    /** Renders/appends dom elements of the form */\n    _renderForm: function() {\n        $(\".tooltip\").remove();\n        var options = this.model.attributes;\n        this.message = new Ui.UnescapedMessage();\n        this.section = new FormSection.View(this, {\n            inputs: options.inputs\n        });\n        this.portlet = new Portlet.View({\n            icon: options.icon,\n            title: options.title,\n            title_id: options.title_id,\n            cls: options.cls,\n            operations: !options.hide_operations && options.operations,\n            buttons: options.buttons,\n            collapsible: options.collapsible,\n            collapsed: options.collapsed,\n            onchange_title: options.onchange_title\n        });\n        this.portlet.append(this.message.$el);\n        this.portlet.append(this.section.$el);\n        this.$el.empty();\n        if (options.inputs) {\n            this.$el.append(this.portlet.$el);\n        }\n        if (options.message) {\n            this.message.update({\n                persistent: true,\n                status: options.status,\n                message: options.message\n            });\n        }\n        Galaxy.emit.debug(\"form-view::initialize()\", \"Completed\");\n    }\n});\n"]}