define("mvc/tool/tool-form",["exports","utils/localization","utils/utils","mvc/ui/ui-misc","mvc/ui/ui-modal","mvc/tool/tool-form-base","mvc/webhooks"],function(e,t,o,i,a,r,l){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0});var n=s(t),u=s(o),d=s(i),c=s(a),f=s(r),h=s(l),m=Backbone.View.extend({initialize:function(e){var t=this;this.modal=parent.Galaxy.modal||new c.default.View,this.form=new f.default(u.default.merge({listen_to_history:!0,always_refresh:!1,buildmodel:function(e,o){var i=o.model.attributes,a="",r={},l=i.job_id;l?a=Galaxy.root+"api/jobs/"+l+"/build_for_rerun":(a=Galaxy.root+"api/tools/"+i.id+"/build",(r=$.extend({},Galaxy.params)).tool_id&&delete r.tool_id),i.version&&(r.tool_version=i.version),u.default.get({url:a,data:r,success:function(i){i.display?(o.model.set(i),t._customize(o),Galaxy.emit.debug("tool-form-base::_buildModel()","Initial tool model ready.",i),e.resolve()):window.location=Galaxy.root},error:function(t,a){var r=t&&t.err_msg||"Uncaught error.";401==a?window.location=Galaxy.root+"user/login?"+$.param({redirect:Galaxy.root+"?tool_id="+i.id}):o.$el.is(":empty")?o.$el.prepend(new d.default.Message({message:r,status:"danger",persistent:!0,large:!0}).$el):Galaxy.modal&&Galaxy.modal.show({title:(0,n.default)("Tool request failed"),body:r,buttons:{Close:function(){Galaxy.modal.hide()}}}),Galaxy.emit.debug("tool-form-base::_buildModel()","Initial tool model request failed.",t),e.reject()}})},postchange:function(e,t){var o={tool_id:t.model.get("id"),tool_version:t.model.get("version"),inputs:$.extend(!0,{},t.data.create())};t.wait(!0),Galaxy.emit.debug("tool-form::postchange()","Sending current state.",o),u.default.request({type:"POST",url:Galaxy.root+"api/tools/"+t.model.get("id")+"/build",data:o,success:function(o){t.update(o),t.wait(!1),Galaxy.emit.debug("tool-form::postchange()","Received new model.",o),e.resolve()},error:function(t){Galaxy.emit.debug("tool-form::postchange()","Refresh request failed.",t),e.reject()}})}},e)),this.deferred=this.form.deferred,this.setElement("<div/>"),this.$el.append(this.form.$el)},_customize:function(e){var t=this,o=e.model.attributes,i=new d.default.Button({icon:"fa-check",tooltip:"Execute: "+o.name+" ("+o.version+")",title:(0,n.default)("Execute"),cls:"btn btn-primary ui-clear-float",wait_cls:"btn btn-info ui-clear-float",onclick:function(){i.wait(),e.portlet.disable(),t.submit(o,function(){i.unwait(),e.portlet.enable()})}});if(o.buttons={execute:i},o.job_id&&o.job_remap){if("job_produced_collection_elements"===o.job_remap)var a="Replace elements in collection ?",r="The previous run of this tool failed. Use this option to replace the failed element(s) in the dataset collection that were produced during the previous tool run.";else var a="Resume dependencies from this job ?",r="The previous run of this tool failed and other tools were waiting for it to finish successfully. Use this option to resume those tools using the new output(s) of this tool run.";o.inputs.push({label:a,name:"rerun_remap_job_id",type:"select",display:"radio",ignore:"__ignore__",value:"__ignore__",options:[["Yes",o.job_id],["No","__ignore__"]],help:r})}var l={};Galaxy.user.attributes.preferences&&"extra_user_preferences"in Galaxy.user.attributes.preferences&&(l=JSON.parse(Galaxy.user.attributes.preferences.extra_user_preferences)),"true"===("use_cached_job|use_cached_job_checkbox"in l&&l["use_cached_job|use_cached_job_checkbox"])&&o.inputs.push({label:"BETA: Attempt to re-use jobs with identical parameters ?",help:"This may skip executing jobs that you have already run",name:"use_cached_job",type:"select",display:"radio",ignore:"__ignore__",value:"__ignore__",options:[["No",!1],["Yes",!0]]})},submit:function(e,t){var o=this,i={tool_id:e.id,tool_version:e.version,inputs:this.form.data.create()};if(this.form.trigger("reset"),!o.validate(i))return Galaxy.emit.debug("tool-form::submit()","Submission canceled. Validation failed."),void(t&&t());if(e.action!==Galaxy.root+"tool_runner/index"){var a=$("<form/>").attr({action:e.action,method:e.method,enctype:e.enctype});return _.each(i.inputs,function(e,t){a.append($("<input/>").attr({name:t,value:e}))}),a.hide().appendTo("body").submit().remove(),void(t&&t())}Galaxy.emit.debug("tool-form::submit()","Validation complete.",i),u.default.request({type:"POST",url:Galaxy.root+"api/tools",data:i,success:function(e){if(t&&t(),o.$el.children().hide(),o.$el.append(o._templateSuccess(e,i)),e.jobs&&e.jobs.length>0){o.$el.append($("<div/>",{id:"webhook-view"}));new h.default.WebhookView({type:"tool",toolId:i.tool_id})}parent.Galaxy&&parent.Galaxy.currHistoryPanel&&parent.Galaxy.currHistoryPanel.refreshContents()},error:function(e){t&&t(),Galaxy.emit.debug("tool-form::submit","Submission failed.",e);var a=!1;if(e&&e.err_data){var r=o.form.data.matchResponse(e.err_data);for(var l in r){o.form.highlight(l,r[l]),a=!0;break}}a||o.modal.show({title:(0,n.default)("Job submission failed"),body:o._templateError(i,e&&e.err_msg),buttons:{Close:function(){o.modal.hide()}}})}})},validate:function(e){var t=this,o=e.inputs,i=-1,a=null;for(var r in o){var l=o[r],s=this.form.data.match(r),n=this.form.field_list[s],u=this.form.input_list[s];if(s&&u&&n){if(!u.optional&&null==l)return this.form.highlight(s),!1;if(n.validate){var d=n.validate(function(){t.form.trigger("reset")});if(!d.valid)return this.form.highlight(s,d.message),!1}if(l&&l.batch){var c=l.values.length,f=c>0&&l.values[0]&&l.values[0].src;if(f)if(null===a)a=f;else if(a!==f)return this.form.highlight(s,"Please select either dataset or dataset list fields for all batch mode fields."),!1;if(-1===i)i=c;else if(i!==c)return this.form.highlight(s,"Please make sure that you select the same number of inputs for all batch mode fields. This field contains <b>"+c+"</b> selection(s) while a previous field contains <b>"+i+"</b>."),!1}}else Galaxy.emit.debug("tool-form::validate()","Retrieving input objects failed.")}return!0},_getInputs:function(e){var t=[],o={};for(var i in e.inputs){var a=e.inputs[i];if(a&&$.isArray(a.values)){var r=!0,l=!1,s=void 0;try{for(var n,u=a.values[Symbol.iterator]();!(r=(n=u.next()).done);r=!0){var d=n.value;d.src&&!o[d.id]&&(t.push(d),o[d.id]=!0)}}catch(e){l=!0,s=e}finally{try{!r&&u.return&&u.return()}finally{if(l)throw s}}}}return t},_templateRow:function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,i="";if(e.sort(function(e,t){return t.hid-e.hid}),e.length>0){i+="<p>"+t+":</p>";var a=!0,r=!1,l=void 0;try{for(var s,n=e[Symbol.iterator]();!(a=(s=n.next()).done);a=!0){var u=s.value;if(i+='<p class="messagerow">\n                            <b>'+(o>0?u.hid+": "+u.name:"...")+"</b>\n                          </p>",o--<=0)break}}catch(e){r=!0,l=e}finally{try{!a&&n.return&&n.return()}finally{if(r)throw l}}}return i},_templateSuccess:function(e,t){var o=e.jobs.length;if(o>0){var i=this._getInputs(t),a=i.length,r=e.outputs.length,l=o>1?o+" jobs":"1 job",s=a>1?a+" inputs":"this input",n=r>1?r+" outputs":"this output";return'<div class="donemessagelarge">\n                        <p>\n                            Executed <b>'+this.form.model.get("name")+"</b> and successfully added "+l+" to the queue.\n                        </p>\n                        "+this._templateRow(i,"The tool uses "+s)+"\n                        "+this._templateRow(e.outputs,"It produces "+n)+"\n                        <p>\n                            You can check the status of queued jobs and view the resulting data by refreshing the History panel. When the job has been run the status will change from 'running' to 'finished' if completed successfully or 'error' if problems were encountered.\n                        </p>\n                    </div>"}return this._templateError(e,"Invalid success response. No jobs found.")},_templateError:function(e,t){return $("<div/>").addClass("errormessagelarge").append($("<p/>").text("The server could not complete the request. Please contact the Galaxy Team if this error persists. "+(t||""))).append($("<pre/>").text(JSON.stringify(e,null,4)))}});e.default={View:m}});