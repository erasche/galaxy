define("mvc/workflow/workflow-manager",["exports","mvc/workflow/workflow-connector","libs/toastr"],function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(t){return t&&t.__esModule?t:{default:t}}(e),i=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}(n),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),c=function(){function t(e,n){o(this,t),this.app=e,this.canvas_container=n,this.id_counter=0,this.nodes={},this.name=null,this.has_changes=!1,this.active_form_has_changes=!1,this.workflowOutputLabels={},this.workflow_version=0}return s(t,[{key:"canLabelOutputWith",value:function(t){return!t||!(t in this.workflowOutputLabels)}},{key:"registerOutputLabel",value:function(t){t&&(this.workflowOutputLabels[t]=!0)}},{key:"unregisterOutputLabel",value:function(t){t&&delete this.workflowOutputLabels[t]}},{key:"updateOutputLabel",value:function(t,e){t&&this.unregisterOutputLabel(t),this.canLabelOutputWith(e)||i.warning("Workflow contains duplicate workflow output labels "+e+". This must be fixed before it can be saved."),e&&this.registerOutputLabel(e)}},{key:"attemptUpdateOutputLabel",value:function(t,e,n){return!!this.canLabelOutputWith(n)&&(t.labelWorkflowOutput(e,n),t.nodeView.redrawWorkflowOutputs(),!0)}},{key:"create_node",value:function(t,e,n){var o=this.app.prebuildNode(t,e,n);return this.add_node(o),this.fit_canvas_to_nodes(),this.app.canvas_manager.draw_overview(),this.activate_node(o),o}},{key:"add_node",value:function(t){t.id=this.id_counter,t.element.attr("id","wf-node-step-"+t.id),t.element.attr("node-label",t.label),this.id_counter++,this.nodes[t.id]=t,this.has_changes=!0,t.workflow=this}},{key:"remove_node",value:function(t){this.active_node==t&&this.clear_active_node(),delete this.nodes[t.id],this.has_changes=!0}},{key:"remove_all",value:function(){var t=this;$.each(this.nodes,function(e,n){n.destroy(),t.remove_node(n)})}},{key:"rectify_workflow_outputs",value:function(){var t=this,e=!1,n=!1;$.each(this.nodes,function(t,o){o.workflow_outputs&&o.workflow_outputs.length>0&&(e=!0),$.each(o.post_job_actions,function(t,e){"HideDatasetAction"===e.action_type&&(n=!0)})}),!1===e&&!1===n||$.each(this.nodes,function(n,o){if("tool"===o.type){var a=!1;null===o.post_job_actions&&(o.post_job_actions={},a=!0);var i=[];$.each(o.post_job_actions,function(t,e){"HideDatasetAction"==e.action_type&&i.push(t)}),i.length>0&&$.each(i,function(t,e){a=!0,delete o.post_job_actions[e]}),e&&$.each(o.output_terminals,function(t,e){if(!0===!o.isWorkflowOutput(e.name)){a=!0;var n={action_type:"HideDatasetAction",output_name:e.name,action_arguments:{}};o.post_job_actions["HideDatasetAction"+e.name]=null,o.post_job_actions["HideDatasetAction"+e.name]=n}}),t.active_node==o&&!0===a&&t.reload_active_node()}})}},{key:"to_simple",value:function(){var t={};return $.each(this.nodes,function(e,n){var o={};$.each(n.input_terminals,function(t,e){o[e.name]=null;var n=[];$.each(e.connectors,function(t,a){if(a.handle1){var i={id:a.handle1.node.id,output_name:a.handle1.name},s=e.attributes.input.input_subworkflow_step_id;void 0!==s&&(i.input_subworkflow_step_id=s),n[t]=i,o[e.name]=n}})});var a={};n.post_job_actions&&$.each(n.post_job_actions,function(t,e){var n={action_type:e.action_type,output_name:e.output_name,action_arguments:e.action_arguments};a[e.action_type+e.output_name]=null,a[e.action_type+e.output_name]=n}),n.workflow_outputs||(n.workflow_outputs=[]);var i={id:n.id,type:n.type,content_id:n.content_id,tool_version:n.config_form.version,tool_state:n.tool_state,errors:n.errors,input_connections:o,position:$(n.element).position(),annotation:n.annotation,post_job_actions:n.post_job_actions,uuid:n.uuid,label:n.label,workflow_outputs:n.workflow_outputs};t[n.id]=i}),{steps:t}}},{key:"from_simple",value:function(t,e){var n=void 0===e||e,o=this,i=0;n?o.name=t.name:i=Object.keys(o.nodes).length;var s=i,c=!1;o.workflow_version=t.version,$.each(t.steps,function(t,e){var a=o.app.prebuildNode(e.type,e.name,e.content_id);n||(e.uuid=null,$.each(e.workflow_outputs,function(t,e){e.uuid=null})),a.init_field_data(e),e.position&&a.element.css({top:e.position.top,left:e.position.left}),a.id=parseInt(e.id)+i,a.element.attr("id","wf-node-step-"+a.id),a.element.attr("node-label",e.label),o.nodes[a.id]=a,s=Math.max(s,parseInt(t)+i),c||(a.workflow_outputs.length>0?c=!0:$.each(a.post_job_actions||[],function(t,e){"HideDatasetAction"===e.action_type&&(c=!0)}))}),o.id_counter=s+1,$.each(t.steps,function(t,e){var n=o.nodes[parseInt(t)+i];$.each(e.input_connections,function(t,e){e&&($.isArray(e)||(e=[e]),$.each(e,function(e,s){var c=o.nodes[parseInt(s.id)+i],u=new a.default;u.connect(c.output_terminals[s.output_name],n.input_terminals[t]),u.redraw()}))}),c&&$.each(n.output_terminals,function(t,e){void 0===n.post_job_actions["HideDatasetAction"+e.name]&&(n.addWorkflowOutput(e.name),$(n.element).find(".callout."+e.name.replace(/(?=[()])/g,"\\")).find("img").attr("src",Galaxy.root+"static/images/fugue/asterisk-small.png"),o.has_changes=!0)})})}},{key:"check_changes_in_active_form",value:function(){this.active_form_has_changes&&(this.has_changes=!0,$("#right-content").find("form").submit(),this.active_form_has_changes=!1)}},{key:"reload_active_node",value:function(){if(this.active_node){var t=this.active_node;this.clear_active_node(),this.activate_node(t)}}},{key:"clear_active_node",value:function(){this.active_node&&(this.active_node.make_inactive(),this.active_node=null),document.activeElement.blur(),this.app.showAttributes()}},{key:"activate_node",value:function(t){this.active_node!=t&&(this.check_changes_in_active_form(),this.clear_active_node(),this.app.showForm(t.config_form,t),t.make_active(),this.active_node=t)}},{key:"node_changed",value:function(t,e){this.has_changes=!0,this.active_node==t&&e&&(this.check_changes_in_active_form(),this.app.showForm(t.config_form,t)),this.app.showWorkflowParameters()}},{key:"layout",value:function(){this.check_changes_in_active_form(),this.has_changes=!0;var t={},e={};$.each(this.nodes,function(n,o){void 0===t[n]&&(t[n]=0),void 0===e[n]&&(e[n]=[])}),$.each(this.nodes,function(n,o){$.each(o.input_terminals,function(n,a){$.each(a.connectors,function(n,a){var i=a.handle1.node;t[o.id]+=1,e[i.id].push(o.id)})})});for(var n=[];;){var o=[];for(var a in t)0===t[a]&&o.push(a);if(0===o.length)break;n.push(o);for(var i in o){var s=o[i];delete t[s];for(var c in e[s])t[e[s][c]]-=1}}if(!t.length){var u=this.nodes,r=80;$.each(n,function(t,e){e.sort(function(t,e){return $(u[t].element).position().top-$(u[e].element).position().top});var n=0,o=30;$.each(e,function(t,e){var a=u[e],i=$(a.element);$(i).css({top:o,left:r}),n=Math.max(n,$(i).width()),o+=$(i).height()+30}),r+=n+80}),$.each(u,function(t,e){e.redraw()})}}},{key:"bounds_for_all_nodes",value:function(){var t,e=1/0,n=-1/0,o=1/0,a=-1/0;return $.each(this.nodes,function(i,s){var c=$(s.element);t=c.position(),e=Math.min(e,t.left),n=Math.max(n,t.left+c.width()),o=Math.min(o,t.top),a=Math.max(a,t.top+c.width())}),{xmin:e,xmax:n,ymin:o,ymax:a}}},{key:"fit_canvas_to_nodes",value:function(){function t(t,e){return Math.ceil(t/e)*e}function e(t,e){return t<e||t>3*e?-(t-(Math.ceil(t%e/e)+1)*e):0}var n=this.app.canvas_manager.canvasZoom,o=this.bounds_for_all_nodes(),a=this.canvas_container.position(),i=this.canvas_container.parent(),s=e(o.xmin,100),c=e(o.ymin,100);s=Math.max(s,a.left),c=Math.max(c,a.top);var u=a.left-s,r=a.top-c,l=t(o.xmax+100,100)+s,h=t(o.ymax+100,100)+c;l=Math.max(l,-u+i.width()),h=Math.max(h,-r+i.height()),this.canvas_container.css({left:u/n,top:r/n,width:l,height:h}),this.canvas_container.children().each(function(){var t=$(this).position();$(this).css("left",(t.left+s)/n),$(this).css("top",(t.top+c)/n)})}}]),t}();t.default=c});