define("mvc/workflow/workflow-view",["exports","backbone","underscore","utils/localization","utils/utils","mvc/workflow/workflow-manager","mvc/workflow/workflow-canvas","mvc/workflow/workflow-node","mvc/workflow/workflow-icons","mvc/workflow/workflow-forms","mvc/ui/ui-misc","utils/async-save-text","ui/editable-text"],function(o,e,t,i,n,a,s,l,r,w,d,f){"use strict";function c(o){return o&&o.__esModule?o:{default:o}}function u(o){if(o&&o.__esModule)return o;var e={};if(null!=o)for(var t in o)Object.prototype.hasOwnProperty.call(o,t)&&(e[t]=o[t]);return e.default=o,e}function h(o){var e=$("#galaxy_tools").contents();0===e.length&&(e=$(document),$(this).removeClass("search_active"),e.find(".toolTitle").removeClass("search_match"),e.find(".toolSectionBody").hide(),e.find(".toolTitle").show(),e.find(".toolPanelLabel").show(),e.find(".toolSectionWrapper").each(function(){"recently_used_wrapper"!==$(this).attr("id")?$(this).show():$(this).hasClass("user_pref_visible")&&$(this).show()}),e.find("#search-no-results").hide(),e.find("#search-spinner").hide(),o&&e.find("#tool-search-query").val("search tools"))}function p(o,e){var t=x.default[e];if(t){var i=$('<i class="icon fa">&nbsp;</i>').addClass(t);o.before(i)}}Object.defineProperty(o,"__esModule",{value:!0});var _=u(e),v=u(t),k=c(i),m=c(n),g=c(a),y=c(s),b=c(l),x=c(r),S=c(w),T=c(d),C=c(f);window.workflow_globals=window.workflow_globals||{},o.default=_.View.extend({initialize:function(o){function e(){$.jStorage.set("overview-off",!1),$("#overview-border").css("right","0px"),$("#close-viewport").css("background-position","0px 0px")}function t(){$.jStorage.set("overview-off",!0),$("#overview-border").css("right","20000px"),$("#close-viewport").css("background-position","12px 0px")}var i=window.workflow_globals.app=this;this.options=o,this.urls=o&&o.urls||{};var n=i.urls.workflow_index,a=function(o,e){if(show_message("Saving workflow","progress"),i.workflow.check_changes_in_active_form(),!i.workflow.has_changes)return hide_modal(),void(e&&e());i.workflow.rectify_workflow_outputs(),m.default.request({url:Galaxy.root+"api/workflows/"+i.options.id,type:"PUT",data:{workflow:i.workflow.to_simple()},success:function(o){var t=$("<div/>").text(o.message);if(o.errors){t.addClass("warningmark");var n=$("<ul/>");$.each(o.errors,function(o,e){$("<li/>").text(e).appendTo(n)}),t.append(n)}else t.addClass("donemark");i.workflow.name=o.name,i.workflow.has_changes=!1,i.workflow.stored=!0,i.workflow.workflow_version=o.version,i.showWorkflowParameters(),i.build_version_select(),o.errors?window.show_modal("Saving workflow",t,{Ok:hide_modal}):(e&&e(),hide_modal())},error:function(o){window.show_modal("Saving workflow failed.",o.err_msg,{Ok:hide_modal})}})};$("#search-clear-btn").click(function(){$("#tool-search-query").val(""),h(!1)}),$("#tool-search-query").click(function(){$(this).focus(),$(this).select()}).keyup(function(o){if(27==o.keyCode&&(this.value=""),$(this).css("font-style","normal"),this.value.length<3)h(!1);else if(this.value!=this.lastValue){$(this).addClass("search_active");var e=this.value;this.timer&&window.clearTimeout(this.timer),$("#search-spinner").show(),this.timer=window.setTimeout(function(){$.get(i.urls.tool_search,{q:e},function(o){if($("#search-no-results").hide(),$(".toolSectionWrapper").hide(),$(".toolSectionWrapper").find(".toolTitle").hide(),0!==o.length){var e=$.map(o,function(o,e){return"link-"+o});$(e).each(function(o,e){$("[id='"+e+"']").parent().addClass("search_match"),$("[id='"+e+"']").parent().show().parent().parent().show().parent().show()}),$(".toolPanelLabel").each(function(){for(var o=$(this),e=o.next(),t=!0;0!==e.length&&e.hasClass("toolTitle");){if(e.is(":visible")){t=!1;break}e=e.next()}t&&o.hide()})}else $("#search-no-results").show();$("#search-spinner").hide()},"json")},400)}this.lastValue=this.value}),this.canvas_manager=window.workflow_globals.canvas_manager=new y.default(this,$("#canvas-viewport"),$("#overview")),this.reset(),this.datatypes=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes",async:!1}).responseText),this.datatypes_mapping=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes/mapping",async:!1}).responseText),this.ext_to_type=this.datatypes_mapping.ext_to_class_name,this.type_to_type=this.datatypes_mapping.class_to_classes,this.get_workflow_versions=function(){for(var o={},e=JSON.parse($.ajax({url:Galaxy.root+"api/workflows/"+i.options.id+"/versions",async:!1}).responseText),t=0;t<e.length;t++){var n=e[t],a="Version "+n.version+", "+n.steps+" steps",s=!1;t==i.workflow.workflow_version&&(a+=" (active)",s=!0),o[a]={version:t,selected:s}}return o},this.build_version_select=function(){var o=this.get_workflow_versions();$("#workflow-version-switch").empty(),$.each(o,function(o,e){$("#workflow-version-switch").append($("<option></option>").html(o).val(e.version).selected(e.selected))}),$("#workflow-version-switch").on("change",function(){if($("#workflow-version-switch").unbind("change"),this.value!=i.workflow.workflow_version){if(i.workflow&&i.workflow.has_changes&&0==confirm("There are unsaved changes to your workflow which will be lost. Continue ?"))return void i.build_version_select();i.load_workflow(i.options.id,this.value)}})},this.load_workflow=function(o,e){this._workflowLoadAjax(o,e,{success:function(o){i.reset(),i.workflow.from_simple(o,!0),i.workflow.has_changes=!1,i.workflow.fit_canvas_to_nodes(),i.scroll_to_nodes(),i.canvas_manager.draw_overview(),i.build_version_select();var e="";v.each(o.steps,function(t,n){var a="";t.errors&&(a+="<li>"+t.errors+"</li>"),v.each(o.upgrade_messages[n],function(o){a+="<li>"+o+"</li>"}),a&&(e+="<li>Step "+(parseInt(n,10)+1)+": "+i.workflow.nodes[n].name+"<ul>"+a+"</ul></li>")}),e?window.show_modal("Issues loading this workflow","Please review the following issues, possibly resulting from tool upgrades or changes.<p><ul>"+e+"</ul></p>",{Continue:hide_modal}):hide_modal(),i.showWorkflowParameters()},error:function(o){window.show_modal("Loading workflow failed.",o.err_msg,{Ok:function(o){window.onbeforeunload=void 0,window.document.location=n}})},beforeSubmit:function(o){show_message("Loading workflow","progress")}})},this.load_workflow(i.options.id,i.options.version),window.make_popupmenu&&make_popupmenu($("#workflow-options-button"),{Save:a,"Save As":function(){var o=$('<form><label style="display:inline-block; width: 100%;">Save as name: </label><input type="text" id="workflow_rename" style="width: 80%;" autofocus/><br><label style="display:inline-block; width: 100%;">Annotation: </label><input type="text" id="wf_annotation" style="width: 80%;" /></form>');window.show_modal("Save As a New Workflow",o,{OK:function(){var o=$("#workflow_rename").val().length>0?$("#workflow_rename").val():"SavedAs_"+i.workflow.name,e=$("#wf_annotation").val().length>0?$("#wf_annotation").val():"";$.ajax({url:i.urls.workflow_save_as,type:"POST",data:{workflow_name:o,workflow_annotation:e,workflow_data:function(){return JSON.stringify(i.workflow.to_simple())}}}).done(function(o){window.onbeforeunload=void 0,window.location=Galaxy.root+"workflow/editor?id="+o,hide_modal()}).fail(function(){hide_modal(),alert("Saving this workflow failed. Please contact this site's administrator.")})},Cancel:hide_modal})},Run:function(){window.location=Galaxy.root+"workflows/run?id="+i.options.id},"Edit Attributes":function(){i.workflow.clear_active_node()},"Auto Re-layout":function(){i.workflow.layout(),i.workflow.fit_canvas_to_nodes(),i.scroll_to_nodes(),i.canvas_manager.draw_overview()},Download:{url:Galaxy.root+"api/workflows/"+i.options.id+"/download?format=json-download",action:function(){}},Close:function(){if(i.workflow.check_changes_in_active_form(),i.workflow&&i.workflow.has_changes){var o=function(){window.onbeforeunload=void 0,window.document.location=i.urls.workflow_index};window.show_modal("Close workflow editor","There are unsaved changes to your workflow which will be lost.",{Cancel:hide_modal,"Save Changes":function(){a(null,o)}},{"Don't Save":o})}else window.document.location=i.urls.workflow_index}});var s=$.jStorage.get("overview-size");void 0!==s&&$("#overview-border").css({width:s,height:s}),$.jStorage.get("overview-off")?t():e(),$("#overview-border").bind("dragend",function(o,e){var t=$(this).offsetParent(),i=t.offset(),n=Math.max(t.width()-(e.offsetX-i.left),t.height()-(e.offsetY-i.top));$.jStorage.set("overview-size",n+"px")}),$("#close-viewport").click(function(){"0px"===$("#overview-border").css("right")?t():e()}),window.onbeforeunload=function(){if(i.workflow&&i.workflow.has_changes)return"There are unsaved changes to your workflow which will be lost."},this.options.workflows.length>0&&$("#left").find(".toolMenu").append(this._buildToolPanelWorkflows()),$("div.toolSectionBody").hide(),$("div.toolSectionTitle > span").wrap("<a href='#'></a>");var l=null;$("div.toolSectionTitle").each(function(){var o=$(this).next("div.toolSectionBody");$(this).click(function(){o.is(":hidden")?(l&&l.slideUp("fast"),l=o,o.slideDown("fast")):(o.slideUp("fast"),l=null)})}),(0,C.default)("workflow-name","workflow-name",i.urls.rename_async,"new_name"),$("#workflow-tag").click(function(){return $(".tag-area").click(),!1}),(0,C.default)("workflow-annotation","workflow-annotation",i.urls.annotate_async,"new_annotation",25,!0,4)},_buildToolPanelWorkflows:function(){var o=this,e=$('<div class="toolSectionWrapper"><div class="toolSectionTitle"><a href="#"><span>Workflows</span></a></div><div class="toolSectionBody"><div class="toolSectionBg"/></div></div>');return v.each(this.options.workflows,function(t){if(t.id!==o.options.id){var i=new T.default.ButtonIcon({icon:"fa fa-copy",cls:"ui-button-icon-plain",tooltip:(0,k.default)("Copy and insert individual steps"),onclick:function(){t.step_count<2?o.copy_into_workflow(t.id,t.name):Galaxy.modal.show({title:(0,k.default)("Warning"),body:"This will copy "+t.step_count+" new steps into your workflow.",buttons:{Cancel:function(){Galaxy.modal.hide()},Copy:function(){Galaxy.modal.hide(),o.copy_into_workflow(t.id,t.name)}}})}}),n=$("<a/>").attr("href","#").html(t.name).on("click",function(){o.add_node_for_subworkflow(t.latest_id,t.name)});e.find(".toolSectionBg").append($("<div/>").addClass("toolTitle").append(n).append(i.$el))}}),e},copy_into_workflow:function(o){var e=this;this._workflowLoadAjax(o,None,{success:function(o){e.workflow.from_simple(o,!1);var t="";$.each(o.upgrade_messages,function(o,i){t+="<li>Step "+(parseInt(o,10)+1)+": "+e.workflow.nodes[o].name+"<ul>",$.each(i,function(o,e){t+="<li>"+e+"</li>"}),t+="</ul></li>"}),t?window.show_modal("Subworkflow embedded with changes","Problems were encountered loading this workflow (possibly a result of tool upgrades). Please review the following parameters and then save.<ul>"+t+"</ul>",{Continue:hide_modal}):hide_modal()},beforeSubmit:function(o){show_message("Importing workflow","progress")}})},reset:function(){this.workflow&&this.workflow.remove_all(),this.workflow=window.workflow_globals.workflow=new g.default(this,$("#canvas-container"))},scroll_to_nodes:function(){var o,e,t=$("#canvas-viewport"),i=$("#canvas-container");e=i.width()<t.width()?(t.width()-i.width())/2:0,o=i.height()<t.height()?(t.height()-i.height())/2:0,i.css({left:e,top:o})},_workflowLoadAjax:function(o,e,t){$.ajax(m.default.merge(t,{url:this.urls.load_workflow,data:{id:o,_:"true",version:e},dataType:"json",cache:!1}))},_moduleInitAjax:function(o,e){var t=this;m.default.request({type:"POST",url:Galaxy.root+"api/workflows/build_module",data:e,success:function(e){o.init_field_data(e),o.update_field_data(e),t.workflow.activate_node(o)}})},add_node_for_tool:function(o,e){var t=this.workflow.create_node("tool",e,o);this._moduleInitAjax(t,{type:"tool",tool_id:o,_:"true"})},add_node_for_subworkflow:function(o,e){var t=this.workflow.create_node("subworkflow",e,o);this._moduleInitAjax(t,{type:"subworkflow",content_id:o,_:"true"})},add_node_for_module:function(o,e){var t=this.workflow.create_node(o,e);this._moduleInitAjax(t,{type:o,_:"true"})},display_file_list:function(o){var e="<select id='node_data_list' name='node_data_list'>";for(var t in o.output_terminals)e+="<option value='"+t+"'>"+t+"</option>";return e+="</select>"},showWorkflowParameters:function(){var o=/\$\{.+?\}/g,e=[],t=$("#workflow-parameters-container"),i=$("#workflow-parameters-box"),n="",a=[];$.each(this.workflow.nodes,function(t,i){i.config_form&&i.config_form.inputs&&m.default.deepeach(i.config_form.inputs,function(e){if("string"==typeof e.value){var t=e.value.match(o);t&&(a=a.concat(t))}}),i.post_job_actions&&$.each(i.post_job_actions,function(e,t){t.action_arguments&&$.each(t.action_arguments,function(e,t){if("string"==typeof t){var i=t.match(o);i&&(a=a.concat(i))}})}),a&&$.each(a,function(o,t){-1===$.inArray(t,e)&&e.push(t)})}),e&&0!==e.length?($.each(e,function(o,e){n+="<div>"+e.substring(2,e.length-1)+"</div>"}),t.html(n),i.show()):(t.html(n),i.hide())},showAttributes:function(){$(".right-content").hide(),$("#edit-attributes").show()},showForm:function(o,e){var t="right-content",i=t+"-"+e.id,n=$("#"+t);if(o&&0===n.find("#"+i).length){var a=$('<div id="'+i+'" class="'+t+'"/>');if(o.node=e,o.workflow=this.workflow,o.datatypes=this.datatypes,o.icon=x.default[e.type],o.cls="ui-portlet-narrow",e){var s="tool"==e.type?"Tool":"Default";a.append(new S.default[s](o).form.$el),n.append(a)}else Galaxy.emit.debug("workflow-view::initialize()","Node not found in workflow.")}$("."+t).hide(),n.find("#"+i).show(),n.show(),n.scrollTop()},isSubType:function(o,e){return o=this.ext_to_type[o],e=this.ext_to_type[e],this.type_to_type[o]&&e in this.type_to_type[o]},prebuildNode:function(o,e,t){var i=this,n=$("<div class='toolForm toolFormInCanvas'/>"),a=$("<div class='toolFormTitle unselectable'><span class='nodeTitle'>"+e+"</div></div>");p(a.find(".nodeTitle"),o),n.append(a),n.css("left",$(window).scrollLeft()+20),n.css("top",$(window).scrollTop()+20),n.append($("<div class='toolFormBody'></div>"));var s=new b.default(this,{element:n});s.type=o,s.content_id=t;var l="<div><img height='16' align='middle' src='"+Galaxy.root+"static/images/loading_small_white_bg.gif'/> loading tool info...</div>";n.find(".toolFormBody").append(l);var r=$("<div class='buttons' style='float: right;'></div>");"subworkflow"!==o&&r.append($("<div/>").addClass("fa-icon-button fa fa-files-o node-clone").click(function(o){s.clone()})),r.append($("<div/>").addClass("fa-icon-button fa fa-times node-destroy").click(function(o){s.destroy()})),n.appendTo("#canvas-container");var w=$("#canvas-container").position(),d=$("#canvas-container").parent(),f=n.width(),c=n.height();return n.css({left:-w.left+d.width()/2-f/2,top:-w.top+d.height()/2-c/2}),r.prependTo(n.find(".toolFormTitle")),f+=r.width()+10,n.css("width",f),n.bind("dragstart",function(){i.workflow.activate_node(s)}).bind("dragend",function(){i.workflow.node_changed(this),i.workflow.fit_canvas_to_nodes(),i.canvas_manager.draw_overview()}).bind("dragclickonly",function(){i.workflow.activate_node(s)}).bind("drag",function(o,e){var t=$(this).offsetParent().offset(),n=(e.offsetX-t.left)/i.canvas_manager.canvasZoom,a=(e.offsetY-t.top)/i.canvas_manager.canvasZoom;$(this).css({left:n,top:a}),$(this).find(".terminal").each(function(){this.terminal.redraw()})}),s}})});