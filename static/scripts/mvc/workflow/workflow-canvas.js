define("mvc/workflow/workflow-canvas",["exports"],function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function t(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,o,i){return o&&t(e.prototype,o),i&&t(e,i),e}}(),i=function(){function t(o){e(this,t),this.panel=o}return o(t,[{key:"test",value:function(t,e){var o=this;window.clearTimeout(this.timeout);var i=t.pageX,n=t.pageY,a=$(this.panel),s=a.position(),c=a.width(),r=a.height(),h=a.parent(),v=h.width(),f=h.height(),l=h.offset(),d=l.left,p=l.top,w=d+h.width(),u=p+h.height(),m=-(c-v/2),g=-(r-f/2),k=v/2,_=f/2,y=!1,b=0;i-5<d?s.left<k&&(b=Math.min(23,k-s.left),a.css("left",s.left+b),y=!0):i+5>w?s.left>m&&(b=Math.min(23,s.left-m),a.css("left",s.left-b),y=!0):n-5<p?s.top<_&&(b=Math.min(23,_-s.top),a.css("top",s.top+b),y=!0):n+5>u&&s.top>g&&(b=Math.min(23,s.top-m),a.css("top",s.top-b+"px"),y=!0),y&&(e(),this.timeout=window.setTimeout(function(){o.test(t,e)},50))}},{key:"stop",value:function(){window.clearTimeout(this.timeout)}}]),t}(),n=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4],a=7,s=function(){function t(o,i,s){e(this,t),this.app=o,this.cv=i,this.cc=this.cv.find("#canvas-container"),this.overview=s,this.oc=s.find("#overview-canvas"),this.ov=s.find("#overview-viewport"),this.zoomLevel=a,this.canvasZoom=n[a],this.initZoomControls(),this.init_drag(),this.init_copy_paste()}return o(t,[{key:"setZoom",value:function(t){this.zoomLevel=Math.min(Math.max(0,t),n.length),this.canvasZoom=n[this.zoomLevel],this.cv.css("transform-origin","top left"),this.cv.css("transform","scale("+this.canvasZoom+")"),this.cv.css("width",100/this.canvasZoom+"%"),this.cv.css("height",100/this.canvasZoom+"%"),this.app.workflow.fit_canvas_to_nodes()}},{key:"initZoomControls",value:function(){var t=this,e=$('<div class="btn-group-vertical"/>').css({position:"absolute",left:"1rem",bottom:"1rem"});e.append($('<div class="btn btn-secondary fa fa-plus"/>').click(function(){return t.setZoom(t.zoomLevel+1)})),e.append($('<div class="btn btn-secondary fa fa-minus"/>').click(function(){return t.setZoom(t.zoomLevel-1)})),this.cv.closest("#workflow-canvas-body").append(e)}},{key:"init_drag",value:function(){var t=this,e=this,o=function(t,o){t=Math.min(t,e.cv.width()/2),t=Math.max(t,-e.cc.width()+e.cv.width()/2),o=Math.min(o,e.cv.height()/2),o=Math.max(o,-e.cc.height()+e.cv.height()/2),e.cc.css({left:t,top:o}),e.cv.css({"background-position-x":t,"background-position-y":o}),e.update_viewport_overlay()};this.cc.each(function(){this.scroll_panel=new i(this)});var n,a;this.cv.bind("click",function(){document.activeElement.blur()}).bind("dragstart",function(){var t=$(this).offset(),o=e.cc.position();a=o.top-t.top,n=o.left-t.left}).bind("drag",function(e,i){o((i.offsetX+n)/t.canvasZoom,(i.offsetY+a)/t.canvasZoom)}).bind("dragend",function(){e.app.workflow.fit_canvas_to_nodes(),e.draw_overview()}),this.overview.click(function(t){if(e.overview.hasClass("blockaclick"))e.overview.removeClass("blockaclick");else{var i=e.cc.width(),n=e.cc.height(),a=e.oc.width(),s=e.oc.height(),c=t.pageX-e.oc.offset().left-e.ov.width()/2,r=t.pageY-e.oc.offset().top-e.ov.height()/2;o(-c/a*i,-r/s*n),e.app.workflow.fit_canvas_to_nodes(),e.draw_overview()}}),this.ov.bind("drag",function(t,i){var n=e.cc.width(),a=e.cc.height(),s=e.oc.width(),c=e.oc.height(),r=i.offsetX-e.overview.offset().left,h=i.offsetY-e.overview.offset().top;o(-r/s*n,-h/c*a)}).bind("dragend",function(){e.overview.addClass("blockaclick"),e.app.workflow.fit_canvas_to_nodes(),e.draw_overview()}),$("#overview-border").bind("drag",function(t,o){var i=$(this).offsetParent(),n=i.offset(),a=Math.max(i.width()-(o.offsetX-n.left),i.height()-(o.offsetY-n.top));$(this).css({width:a,height:a}),e.draw_overview()}),$("#overview-border div").bind("drag",function(){})}},{key:"init_copy_paste",value:function(){var t=this;document.addEventListener("copy",function(e){""===window.getSelection().toString()&&(t.app.workflow.active_node&&"subworkflow"!==t.app.workflow.active_node.type&&e.clipboardData.setData("application/json",JSON.stringify({nodeId:t.app.workflow.active_node.id})),e.preventDefault())}),document.addEventListener("paste",function(e){if(document.activeElement&&"textarea"!==document.activeElement.type&&"text"!==document.activeElement.type){var o;try{o=JSON.parse(e.clipboardData.getData("application/json")).nodeId}catch(t){console.debug(t)}o&&t.app.workflow.nodes.hasOwnProperty(o)&&t.app.workflow.nodes[o].clone(),e.preventDefault()}})}},{key:"update_viewport_overlay",value:function(){var t=this.cc,e=this.cv,o=this.oc,i=this.ov,n=t.width(),a=t.height(),s=o.width(),c=o.height(),r=t.position();i.css({left:-r.left/n*s,top:-r.top/a*c,width:e.width()/n*s-2,height:e.height()/a*c-2})}},{key:"draw_overview",value:function(){var t,e,o,i,n=$("#overview-canvas"),a=n.parent().parent().width(),s=n.get(0).getContext("2d"),c=$("#canvas-container").width(),r=$("#canvas-container").height(),h=this.cv.width(),v=this.cv.height();c<h&&r<v?(i=(a-(o=c/h*a))/2,e=(a-(t=r/v*a))/2):c<r?(e=0,t=a,i=(a-(o=Math.ceil(t*c/r)))/2):(o=a,i=0,e=(a-(t=Math.ceil(o*r/c)))/2),n.parent().css({left:i,top:e,width:o,height:t}),n.attr("width",o),n.attr("height",t),$.each(this.app.workflow.nodes,function(e,i){s.fillStyle="#D2C099",s.strokeStyle="#D8B365",s.lineWidth=1;var n=$(i.element),a=n.position(),h=a.left/c*o,v=a.top/r*t,f=n.width()/c*o,l=n.height()/r*t;i.errors?(s.fillStyle="#FFCCCC",s.strokeStyle="#AA6666"):void 0!==i.workflow_outputs&&i.workflow_outputs.length>0&&(s.fillStyle="#E8A92D",s.strokeStyle="#E8A92D"),s.fillRect(h,v,f,l),s.strokeRect(h,v,f,l)}),this.update_viewport_overlay()}}]),t}();t.default=s});