define("layout/scratchbook",["exports","backbone","underscore","mvc/ui/ui-frames","mvc/dataset/data","viz/visualization","viz/trackster","utils/localization"],function(e,t,a,i,n,o,r,l){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}Object.defineProperty(e,"__esModule",{value:!0});var d=c(t),u=c(a),f=s(i),h=s(n),v=s(o),_=s(r),b=s(l);e.default=d.View.extend({initialize:function(e){var t=this;e=e||{},this.frames=new f.default.View({visible:!1}),this.setElement(this.frames.$el),this.active=!1,this.buttonActive=e.collection.add({id:"enable-scratchbook",icon:"fa-th",tooltip:(0,b.default)("Enable/Disable Scratchbook"),onclick:function(){t.active=!t.active,t.buttonActive.set({toggle:t.active,show_note:t.active,note_cls:t.active&&"fa fa-check"}),t.active||t.frames.hide()},onbeforeunload:function(){if(t.frames.length()>0)return"You opened "+t.frames.length()+" frame(s) which will be lost."}}),this.buttonLoad=e.collection.add({id:"show-scratchbook",icon:"fa-eye",tooltip:(0,b.default)("Show/Hide Scratchbook"),show_note:!0,visible:!1,onclick:function(e){t.frames.visible?t.frames.hide():t.frames.show()}}),this.frames.on("add remove",function(){t.frames.visible&&0===t.frames.length()&&t.frames.hide(),t.buttonLoad.set({note:t.frames.length(),visible:t.frames.length()>0})}).on("show hide ",function(){t.buttonLoad.set({toggle:t.frames.visible,icon:t.frames.visible&&"fa-eye"||"fa-eye-slash"})}),this.history_cache={}},addDataset:function(e){var t=this,a=null;if(Galaxy&&Galaxy.currHistoryPanel){var i=Galaxy.currHistoryPanel.collection.historyId;this.history_cache[i]={name:Galaxy.currHistoryPanel.model.get("name"),dataset_ids:[]},Galaxy.currHistoryPanel.collection.each(function(e){!e.get("deleted")&&e.get("visible")&&t.history_cache[i].dataset_ids.push(e.get("id"))})}var n=function(e,a){if(e){var i=t.history_cache[e.get("history_id")];if(i&&i.dataset_ids){var n=i.dataset_ids,o=n.indexOf(e.get("id"));if(-1!==o&&o+a>=0&&o+a<n.length)return n[o+a]}}},o=function(e,i,o){var r=n(e,i);r?t._loadDataset(r,function(e,t){a=e,o.model.set(t)}):o.model.trigger("change")};this._loadDataset(e,function(e,i){a=e,t.add(u.extend({menu:[{icon:"fa fa-chevron-circle-left",tooltip:(0,b.default)("Previous in History"),onclick:function(e){o(a,-1,e)},disabled:function(){return!n(a,-1)}},{icon:"fa fa-chevron-circle-right",tooltip:(0,b.default)("Next in History"),onclick:function(e){o(a,1,e)},disabled:function(){return!n(a,1)}}]},i))})},_loadDataset:function(e,t){var a=this,i=new h.default.Dataset({id:e});$.when(i.fetch()).then(function(){var n=u.find(["tabular","interval"],function(e){return-1!==i.get("data_type").indexOf(e)}),o=i.get("name"),r=a.history_cache[i.get("history_id")];r&&(o=r.name+": "+o),t(i,n?{title:o,url:null,content:h.default.createTabularDatasetChunkedView({model:new h.default.TabularDataset(i.toJSON()),embedded:!0,height:"100%"}).$el}:{title:o,url:Galaxy.root+"datasets/"+e+"/display/?preview=True",content:null})})},addTrackster:function(e){var t=this,a=new v.default.Visualization({id:e});$.when(a.fetch()).then(function(){var e=new _.default.TracksterUI(Galaxy.root),i={title:a.get("name"),type:"other",content:function(t){var i={container:t,name:a.get("title"),id:a.id,dbkey:a.get("dbkey"),stand_alone:!1},n=a.get("latest_revision"),o=n.config.view.drawables;u.each(o,function(e){e.dataset={hda_ldda:e.hda_ldda,id:e.dataset_id}}),e.create_visualization(i,n.config.viewport,n.config.view.drawables,n.config.bookmarks,!1)}};t.add(i)})},add:function(e){if("_blank"==e.target)window.open(e.url);else if("_top"==e.target||"_parent"==e.target||"_self"==e.target)window.location=e.url;else if(!this.active||e.noscratchbook){var t=$(window.parent.document).find("#galaxy_main");"galaxy_main"==e.target||"center"==e.target?0===t.length?window.location=this._build_url(e.url,{use_panels:!0}):t.attr("src",e.url):window.location=e.url}else e.url=this._build_url(e.url,{hide_panels:!0,hide_masthead:!0}),this.frames.add(e)},_build_url:function(e,t){if(e)return e+=-1==e.indexOf("?")?"?":"&",e+=$.param(t,!0)}})});